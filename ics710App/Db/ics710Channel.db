## functionality: waveform data of individual channel; waveform data analysis; DC offset of individual channel
## Yong Hu: ext.3961; 
## PREFIX	- follows NSLS2 naming: [PSy[:PI]][-SSy[:SI]][-TSy[:TI]]{Dev[:DI]}[SgN[:SgI][-SgD]]
#### Psy	-	Primary system
#### Ssy	-	Secondary system
#### Dev	-	Device name
## CHANNEL  -	device(Dev) instance and #channel of the board(MODULE)  
## CARD     -	#board / digitizer; "0" refers to the first digitizer found during initialization. \\
##              For Acqiris crate and Concurrent CPU, it's the top slot(#5) if there's one digitizer in slot 5 
## NELM     -	max. number of elements of waveform record 

#raw waveform data: 32-bit integer
record(waveform,"${PREFIX}RawWf-I_")
{
   field(SCAN,"I/O Intr")
   field(DESC,"raw waveform data")
   field(DTYP,"ics710")
   field(NELM,"${NELM}")
   #field(FTVL,"SHORT")
    field(FTVL,"LONG")
   field(INP,"@C${CARD} S${CHANNEL} WRAW")
}

record(waveform,"${PREFIX}VoltWf-I")
{
   field(SCAN,"I/O Intr")
   field(DESC,"voltage waveform data")
   field(DTYP,"ics710")
   field(NELM,"${NELM}")
   field(FTVL,"DOUBLE")
   field(INP,"@C${CARD} S${CHANNEL} WVOL")
   field(PREC,"6")
   field(EGU,"V")
   #forward link to aSub record to process waveform data: mean, min, max, rms, integral, std, etc. ;
   field(FLNK,"${PREFIX}VoltWf-aSub_")
}

#see ics710ProcessWfAsub.cpp: process the waveform record: mean, min, max, integral(sum), std(RMS noise), etc. ;
record(aSub,"${PREFIX}VoltWf-aSub_")
{
    field (DESC,"process waveform data")
    field (INAM,"ics710InitWfAsub")
    field (SNAM,"ics710ProcessWfAsub")
    #get CARD and CHANNEL info from the waveform record
    field (INPA, "${PREFIX}VoltWf-I")
    field (FTA, "DOUBLE")
    field (NOA, "${NELM}")
    field (OUTA, "${PREFIX}AveVolt-I PP")
    field (FTVA, "DOUBLE")
    field (NOVA, "1")
    field (OUTB, "${PREFIX}MaxVolt-I PP")
    field (FTVB, "DOUBLE")
    field (NOVB, "1")
    field (OUTC, "${PREFIX}MinVolt-I PP")
    field (FTVC, "DOUBLE")
    field (NOVC, "1")
    field (OUTD, "${PREFIX}SumVolt-I PP")
    field (FTVD, "DOUBLE")
    field (NOVD, "1")
    field (OUTE, "${PREFIX}StdVolt-I_ PP")
    field (FTVE, "DOUBLE")
    field (NOVE, "1")
    #forward link to another misc. aSub record to get trigger rate, set DC offset, etc.
    field (FLNK, "${PREFIX}Misc-aSub_")
}

record(ai,"${PREFIX}AveVolt-I")
{
   field(DESC,"averaged voltage")
   field(INP,"${PREFIX}VoltWf-aSub_.VALA")
   field(PREC,"6")
   field(EGU,"V")
}

#average the 1Hz/10Hz/1.2Hz data over 60 samples
record(compress,"${PREFIX}AveToMin-I")
{
	field(DESC, "Average to minutes(60 samples)")
	field(INP,"${PREFIX}AveVolt-I CP NMS")
	field(ALG,"N to 1 Average")
	#NSAM is similar to NELM of wavefor record 
	field(NSAM,"1")
	#averaging over 60 samples: for NSLS-2, 60 samples/minute, 1-second for life-time computation
	field(N,"60")
	field(PREC,"6")
	field(EGU,"V")
	#field(FLNK, "${PREFIX}CirBuffer-aSub_")
}

#Circular buffer: 60 samples, 1-min data if 1Hz rate
record(compress,"${PREFIX}CirBuffer-I")
{
	field(DESC, "60 Samples buffer")
	field(INP,"${PREFIX}AveVolt-I CP NMS")
	field(ALG,"Circular Buffer")
	field(NSAM,"60")
	field(PREC,"6")
	field(EGU,"V")
	field (FLNK, "${PREFIX}CirBuffer-aSub_")
}

#see ics710ProcessWfAsbu.cpp: process buffered (1-minute) data: standard deviation(RMS noise), etc.
record(aSub,"${PREFIX}CirBuffer-aSub_")
{
    field (DESC,"process circular buffer data")
    field (SNAM,"ics710ProcessCirBufferAsub")
    field (INPA, "${PREFIX}CirBuffer-I")
    field (FTA, "DOUBLE")
    field (NOA, "60")
    field (OUTA, "${PREFIX}StdVoltOverBuffer-I PP")
    field (FTVA, "DOUBLE")
    field (NOVA, "1")
}

record(ai,"${PREFIX}StdVoltOverBuffer-I")
{
   field(DESC,"RMS noise over circular buffer")
   field(INP,"${PREFIX}CirBuffer-aSub_.VALA")
   field(PREC,"6")
   field(EGU,"V")
}

record(ai,"${PREFIX}MaxVolt-I")
{
   field(DESC,"max. voltage")
   field(INP,"${PREFIX}VoltWf-aSub_.VALB")
   field(PREC,"6")
   field(EGU,"V")
}

record(ai,"${PREFIX}MinVolt-I")
{
   field(DESC,"min. voltage")
   field(INP,"${PREFIX}VoltWf-aSub_.VALC")
   field(PREC,"6")
   field(EGU,"V")
}

record(ai,"${PREFIX}SumVolt-I")
{
   field(DESC,"sum voltage")
   field(INP,"${PREFIX}VoltWf-aSub_.VALD")
   field(PREC,"6")
   #field(EGU,"V")
}

record(ai,"${PREFIX}StdVolt-I_")
{
   field(DESC,"std voltage")
   field(INP,"${PREFIX}VoltWf-aSub_.VALE")
   field(PREC,"6")
   field(EGU,"V")
   field(FLNK,"${PREFIX}StdVolt-I")
}

record(calc,"${PREFIX}StdVolt-I")
{
   field(DESC,"std voltage(mV)")
   field(INPA,"${PREFIX}StdVolt-I_")
   field(CALC,"A*(1e+3)")
   field(PREC,"6")
   field(EGU,"mV")
}

#see ics710ProcessWfAsbu.cpp: calculate time spent on different operations and setup DC offset for each channel ;
record(aSub,"${PREFIX}Misc-aSub_")
{
    field(DESC,"Misc. data processing")
    field (SNAM,"ics710ProcessMiscAsub")
    #get CARD and CHANNEL info from the waveform record
    field (INPA, "${PREFIX}VoltWf-I")
    field (FTA, "DOUBLE")
    field (NOA, "${NELM}")
    #set DC offset and input range coefficient of each channel for calibration in ics710Daq.cpp
    field (INPB, "${PREFIX}Offset-SP")
    field (FTB, "DOUBLE")
    field (NOB, "1")
    field (INPC, "${PREFIX}Coeff-SP")
    field (FTC, "DOUBLE")
    field (NOC, "1")
    field (OUTA, "${PREFIX}TrigRate-I PP")
    field (FTVA, "DOUBLE")
    field (NOVA, "1")
    field (OUTB, "${PREFIX}RawDataRdTm-I_ PP")
    field (FTVB, "DOUBLE")
    field (NOVB, "1")
    field (OUTC, "${PREFIX}LoopTm-I_ PP")
    field (FTVC, "DOUBLE")
    field (NOVC, "1")
}

record (ao, "${PREFIX}Offset-SP")
{
    field(DESC,"DC Offset")
    field(SCAN, "Passive")
    field(PINI, "YES")
    #for channle 1
    #field(VAL, "0.0481")
    #for channle 2
    #field(RVAL, "0.1730")
    field (PREC,"5")
    field(EGU,"V")
    #VAL works with autosave
    info(autosaveFields_pass0, "VAL")
 }
 
record (ao, "${PREFIX}Coeff-SP")
{
    field(DESC,"coefficient of input range")
    field(SCAN, "Passive")
    field(PINI, "YES")
    field(VAL, "1.0")
    field (PREC,"5")
    #VAL works with autosave
    info(autosaveFields_pass0, "VAL")
 }
 
record (ai, "${PREFIX}TrigRate-I")
{
    field(DESC,"trigger rate or IOC update rate")
    field(INP,"${PREFIX}Misc-aSub_.VALA")
    field(PREC,"4")
    field(EGU,"Hz")
 }
 
record (ai, "${PREFIX}RawDataRdTm-I_")
{
    field(DESC,"raw Data Readout Time")
    field (INP,"${PREFIX}Misc-aSub_.VALB")
    field (PREC,"6")
    field(EGU,"ms")
 }
 
record (ai, "${PREFIX}LoopTm-I_")
{
    field(DESC,"whole Loop Time")
    field (INP,"${PREFIX}Misc-aSub_.VALC")
    field (PREC,"6")
    field(EGU,"ms")
    field(FLNK, "${PREFIX}Counter-I")
 }
 
record(calc,"${PREFIX}Counter-I")
{
   field(DESC,"trigger counter")
	field(CALC, "A+1")
	field(INPA, "${PREFIX}Counter-I.VAL  NPP NMS")
	#field(TSEL, "${PREFIX}AveVolt-I.TIME")
	#field(FLNK, "LN{GUN}Trip-Cmd.PROC")
}