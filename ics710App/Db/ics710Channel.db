##data of individual channel:raw data, calibrated voltages, DC offset, etc.
#MON NSLS2 naming:[PSy[:PI]][-SSy[:SI]][-TSy[:TI]]{Dev[:DI]}[SgN[:SgI][-SgD]]
#### Psy	-	Primary system
#### Ssy	-	Secondary system
#### Dev	-	Device name
#### MON	-	LTB-BI{ICT:1}
## CHANNEL  -	device(Dev) instance and #channel of the board(MODULE)  
## CARD     -  "0" refers to the first digitizer found during initialization.
# For Acqiris system, it's the top slot(#5) if there's one digitizer in slot 5 
## NELM     -	max. number of elements of waveform record 

#raw waveform data: 32-bit integer
record(waveform,"${MON}Raw-Wf")
{
   field(SCAN,"I/O Intr")
   field(DESC,"raw waveform data")
   field(DTYP,"ics710ReadRawData")
   field(NELM,"${NELM}")
   field(FTVL,"LONG")
   field(INP,"@C${CARD} S${CHANNEL}")
   field(FLNK,"${MON}Raw-aSub_")
}

record(ao, "${MON}Offset-SP")
{
    field(DESC,"DC Offset")
    field(PINI, "YES")
    field(PREC,"5")
    field(EGU,"V")
    info(autosaveFields_pass0, "VAL")
}
 
record(ao, "${MON}Coeff-SP")
{
    field(DESC,"coefficient of input range")
    field(PINI, "YES")
    field(VAL, "1.0")
    field(PREC,"5")
    info(autosaveFields_pass0, "VAL")
}

record(longout,"${MON}StartPoint-SP")
{
   field(DESC,"start sample point of selected region")
   field(PINI,"YES")
   field(DRVH, "${NELM}")
   field(DRVL, "0")
   field(VAL, "0")   
   info(autosaveFields_pass0, "VAL")
   field(FLNK,"${MON}ROISamples-I")
}

record(longout,"${MON}EndPoint-SP")
{
   field(DESC,"end sample point of selected region")
   field(PINI,"YES")
   field(DRVH, "${NELM}")
   field(DRVL, "1")
   field(VAL, "${NELM}")    
   info(autosaveFields_pass0, "VAL")
   field(FLNK,"${MON}ROISamples-I")
}

#see ics710ProcessWfAsub.cpp: 
#data processing: convert raw data to voltages, mean, min, max, integral(sum),
#std(RMS noise), etc. ;
record(aSub,"${MON}Raw-aSub_")
{
    field (DESC,"process raw data")
    field (SNAM,"processWf")
 #get raw waveform data (32-bit == sizeof(long))
    field (INPA, "${MON}Raw-Wf")
    field (FTA, "LONG")
    field (NOA, "${NELM}")
#get DC offset, input range coefficient    
    field (INPB, "${MON}Offset-SP")
    field (FTB, "DOUBLE")
    field (NOB, "1")
#get input range coefficient such as 0.9834, 0.9943, 1.00     
    field (INPC, "${MON}Coeff-SP")
    field (FTC, "DOUBLE")
    field (NOC, "1")    
#get start sample point of selected region   
    field (INPD, "${MON}StartPoint-SP")
    field (FTD, "ULONG")
    field (NOD, "1")    
#get end sample point of selected region   
    field (INPE, "${MON}EndPoint-SP")
    field (FTE, "ULONG")
    field (NOE, "1")    
#voltages calibrated against gain, DC offset, gain coefficient      
    field (OUTA, "${MON}V-Wf PP")
    field (FTVA, "DOUBLE")
    field (NOVA, "${NELM}")
#data processing results: mean, max, min, sum, std, etc.   
#over part of the waveform (selected region) and within the whole waveform
    field (OUTB, "${MON}AveV-I PP")
    field (FTVB, "DOUBLE")
    field (NOVB, "1")
    field (OUTC, "${MON}MaxV-I PP")
    field (FTVC, "DOUBLE")
    field (NOVC, "1")
    field (OUTD, "${MON}MinV-I PP")
    field (FTVD, "DOUBLE")
    field (NOVD, "1")
    field (OUTE, "${MON}SumV-I PP")
    field (FTVE, "DOUBLE")
    field (NOVE, "1")
    field (OUTF, "${MON}StdV-I_ PP")
    field (FTVF, "DOUBLE")
    field (NOVF, "1")
    field (OUTG, "${MON}AveVROI-I PP")
    field (FTVG, "DOUBLE")
    field (NOVG, "1")
    field (OUTH, "${MON}MaxVROI-I PP")
    field (FTVH, "DOUBLE")
    field (NOVH, "1")
    field (OUTI, "${MON}MinVROI-I PP")
    field (FTVI, "DOUBLE")
    field (NOVI, "1")
    field (OUTJ, "${MON}SumVROI-I PP")
    field (FTVJ, "DOUBLE")
    field (NOVJ, "1")
    field (OUTK, "${MON}StdVROI-I_ PP")
    field (FTVK, "DOUBLE")
    field (NOVK, "1")    
    field (OUTL, "${MON}ROILength-I PP")
    field (FTVL, "DOUBLE")
    field (NOVL, "1") 
}

record(waveform,"${MON}V-Wf")
{
   field(DESC,"voltage waveform data")
   field(INP,"${MON}Raw-aSub_.VALA")
   field(NELM,"${NELM}")
   field(FTVL,"DOUBLE")
   field(PREC,"6")
   field(EGU,"V")
}

record(ai,"${MON}AveV-I")
{
   field(DESC,"averaged voltage")
   field(INP,"${MON}Raw-aSub_.VALB")
   field(PREC,"6")
   field(EGU,"V")
}

record(ai,"${MON}MaxV-I")
{
   field(DESC,"max. voltage")
   field(INP,"${MON}Raw-aSub_.VALC")
   field(PREC,"6")
   field(EGU,"V")
}

record(ai,"${MON}MinV-I")
{
   field(DESC,"min. voltage")
   field(INP,"${MON}Raw-aSub_.VALD")
   field(PREC,"6")
   field(EGU,"V")
}

record(ai,"${MON}SumV-I")
{
   field(DESC,"sum voltage")
   field(INP,"${MON}Raw-aSub_.VALE")
   field(PREC,"6")
   #field(EGU,"V")
}

record(ai,"${MON}StdV-I_")
{
   field(DESC,"std voltage")
   field(INP,"${MON}Raw-aSub_.VALF")
   field(PREC,"6")
   field(EGU,"V")
   field(FLNK,"${MON}StdV-I")
}

record(calc,"${MON}StdV-I")
{
   field(DESC,"std voltage(mV)")
   field(INPA,"${MON}StdV-I_")
   field(CALC,"A*(1e+3)")
   field(PREC,"6")
   field(EGU,"mV")
}

record(ai,"${MON}MaxVROI-I")
{
   field(DESC,"ROI max. voltage")
   field(INP,"${MON}Raw-aSub_.VALH")
   field(PREC,"6")
   field(EGU,"V")
}

record(ai,"${MON}MinVROI-I")
{
   field(DESC,"ROI min. voltage")
   field(INP,"${MON}Raw-aSub_.VALI")
   field(PREC,"6")
   field(EGU,"V")
}

record(ai,"${MON}SumVROI-I")
{
   field(DESC,"ROI sum voltage")
   field(INP,"${MON}Raw-aSub_.VALJ")
   field(PREC,"6")
   #field(EGU,"V")
}

record(ai,"${MON}StdVROI-I_")
{
   field(DESC,"ROI std voltage")
   field(INP,"${MON}Raw-aSub_.VALK")
   field(PREC,"6")
   field(EGU,"V")
   field(FLNK,"${MON}StdVROI-I")
}

record(calc,"${MON}StdVROI-I")
{
   field(DESC,"ROI std voltage(mV)")
   field(INPA,"${MON}StdVROI-I_")
   field(CALC,"A*(1e+3)")
   field(PREC,"6")
   field(EGU,"mV")
}

record(ai,"${MON}ROILength-I")
{
   field(DESC,"ROI length: ms")
   field(INP,"${MON}Raw-aSub_.VALL")
   field(PREC,"3")
   field(EGU,"ms")
}

record(calc,"${MON}ROISamples-I")
{
   field(DESC,"Length of ROI")
   field(INPA,"${MON}StartPoint-SP")
   field(INPB,"${MON}EndPoint-SP")
   field(CALC,"B-A")
   field(PREC,"0")
   field(EGU,"samples")
}

#processed data over ROI (region of interest)
#averaged volt of ROI is for beam charge Q
record(ai,"${MON}AveVROI-I")
{
   field(DESC,"ROI averaged voltage")
   field(INP,"${MON}Raw-aSub_.VALG")
   field(PREC,"6")
   field(EGU,"V")
   #field(FLNK,"${MON}AveVROIOverINOS-I")
   field(FLNK,"${MON}Q-Calc_")
}

#averaging every interested number of shots(INOS)
#averaged Q over INOS is calculated from ${MON}AveVROIOverINOS-I
record(compress,"${MON}AveVROIOverINOS-I")
{
	field(DESC, "average over INOS")
	#INP is scalar
	field(INP,"${MON}AveVROI-I CP")
	field(ALG,"N to 1 Average")
	field(NSAM,"1")
	#N can't be DB_LINK, must be constant
	#field(N,"${MON}NbrShots-SP CP NMS")
	#N can be changed to the interested number of shots at run-time
	field(N,"10")
	field(PREC,"6")
	field(EGU,"V")
	info(autosaveFields_pass0, "N")
}

#beam charge measurement
record(ai,"${MON}FullScale-I")
{
   field(DESC,"ICT/BCM full scale: nC")
   #Full scale is calculated in PLC IOC
   #field(INP,"${MON}FullScale-Calc_ CP")
   field(VAL,"160")
   field(PREC,"1")
   field(EGU,"nC")
   field(FLNK,"${MON}Q-Calc_")
}

#Bergoz ICT charge calibrated against BCM gain settings
record(calc,"${MON}Q-Calc_")
{
   field(DESC,"Beam charge measured by ICT")
   field(INPA,"${MON}AveVROI-I")
   field(INPB,"${MON}FullScale-I")
   field(CALC,"B*(A/8.0)")
   field(PREC,"6")
   field(EGU,"nC")
   field(FLNK,"${MON}Q-I")
}

record(ai,"${MON}Q-I")
{
   field(DESC,"Beam charge measured by ICT")
   field(INP,"${MON}Q-Calc_")
   field(PREC,"6")
   field(EGU,"nC")
   field(FLNK,"${MON}Buffer-aSub_")
}


record(longin,"${MON}EvtRate-I")
{
   field(DESC,"trigger/event rate")
   #field(INP,"from EVR")
   field(VAL,"10")
   field(EGU, "Hz")
}

record(longin,"${MON}Shots-I")
{
   field(DESC,"shots changed in aSub")
   field(VAL,"0")
   field(INP,"${MON}Buffer-aSub_.E")
}

record(longin,"${MON}Events-I")
{
   field(DESC,"events changed in aSub")
   field(VAL,"0")
   field(INP,"${MON}Buffer-aSub_.F")
}

#see ics710ProcessWfAsbu.cpp: process INOS buffered data.
record(aSub,"${MON}Buffer-aSub_")
{
    field (DESC,"process buffered data")
    field (SNAM,"processBuf")
    field (INPA, "${MON}AveVROI-I")
    field (FTA, "DOUBLE")
    field (NOA, "1")
    #N is the interested number of shots
    field (INPB, "${MON}AveVROIOverINOS-I.N")
    field (FTB, "ULONG")
    field (NOB, "1")
    field (INPC, "${MON}Q-I")
    field (FTC, "DOUBLE")
    field (NOC, "1")
    #event rate / injection rate
    field (INPD, "${MON}EvtRate-I")
    field (FTD, "ULONG")
    field (NOD, "1")
    field (INPE, "${MON}Shots-I PP")
    field (FTE, "ULONG")
    field (NOE, "1")
    field (INPF, "${MON}Events-I PP")
    field (FTF, "ULONG")
    field (NOF, "1")
    #${MON}StdQOverINOS-I is calculate from ${MON}StdVROIOverINOS-I
    field (OUTA, "${MON}StdVROIOverINOS-I PP")
    field (FTVA, "DOUBLE")
    field (NOVA, "1")
    field (OUTB, "${MON}QRate-I PP")
    field (FTVB, "DOUBLE")
    field (NOVB, "1")
    field (OUTC, "${MON}AveVROI-Buf_ PP")
    field (FTVC, "DOUBLE")
    field (NOVC, "60")
    field (OUTD, "${MON}Q-Buf_ PP")
    field (FTVD, "DOUBLE")
    field (NOVD, "60")
}

record(ai,"${MON}StdVROIOverINOS-I")
{
   field(DESC,"stdVROI over NOIS")
   field(INP,"${MON}Buffer-aSub_.VALA")
   field(PREC,"6")
   field(EGU,"V")
}

record(ai,"${MON}QRate-I")
{
   field(DESC,"injected charge rate: nC/s")
   field(INP,"${MON}Buffer-aSub_.VALB")
   field(PREC,"6")
   field(EGU,"nC/s")
}

record(waveform,"${MON}AveVROI-Buf_")
{
   field(DESC,"AveVROI buffer")
   field(INP,"${MON}Buffer-aSub_.VALC")
   field(NELM,"60")
   field(FTVL,"DOUBLE")
   field(PREC,"6")
   field(EGU,"V")
}

record(waveform,"${MON}Q-Buf_")
{
   field(DESC,"Q buffer")
   field(INP,"${MON}Buffer-aSub_.VALD")
   field(NELM,"60")
   field(FTVL,"DOUBLE")
   field(PREC,"6")
   field(EGU,"nC")
}

#averaged Q over interested number of shots 
record(calc,"${MON}AveQOverINOS-Calc_")
{
   field(DESC,"averaged charge over INOS")
   field(INPA,"${MON}AveVROIOverINOS-I CP")
   field(INPB,"${MON}FullScale-I")
   field(CALC,"B*(A/8.0)")
   field(PREC,"6")
   field(EGU,"nC")
   field(FLNK,"${MON}AveQOverINOS-I")
}

record(ai,"${MON}AveQOverINOS-I")
{
   field(DESC,"average charge over INOS")
   field(INP,"${MON}AveQOverINOS-Calc_")
   field(PREC,"6")
   field(EGU,"nC")
}

record(calc,"${MON}StdQOverINOS-Calc_")
{
   field(DESC,"std charge over INOS")
   field(INPA,"${MON}StdVROIOverINOS-I CP")
   field(INPB,"${MON}FullScale-I")
   field(CALC,"B*(A/8.0)")
   field(PREC,"6")
   field(EGU,"nC")
   field(FLNK,"${MON}StdQOverINOS-I")
}

record(ai,"${MON}StdQOverINOS-I")
{
   field(DESC,"std charge over INOS")
   field(INP,"${MON}StdQOverINOS-Calc_")
   field(PREC,"6")
   field(EGU,"nC")
}

#Circular buffer: 60 samples of AveVROI, 1-min data if 1Hz rate
record(compress,"${MON}AveVROIBuf-Wf_")
{
	field(DESC, "60 Samples buffer")
	field(INP,"${MON}AveVROI-I CP NMS")
	field(ALG,"Circular Buffer")
	field(NSAM,"60")
	#field(NSAM,"${MON}NbrShots-SP CP NMS")
	field(PREC,"6")
	field(EGU,"V")
	#field (FLNK, "${MON}Buffer-aSub_")
}

#moving average over a window of data
record(compress,"${MON}AveVROIMovAve-I")
{
	field(DESC, "average over INOS")
	#INP is array/circular buffer
	field(INP,"${MON}AveVROIBuf-Wf_ CP NMS")
	field(ALG,"N to 1 Average")
	field(NSAM,"1")
	#N can't be DB_LINK, must be constant
	#field(N,"${MON}NbrShots-SP CP NMS")
	#N is the data window
	field(N,"10")
	field(PREC,"6")
	field(EGU,"V")
	info(autosaveFields_pass0, "N")
}
