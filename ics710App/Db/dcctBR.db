## Process digitizer data to get the beam current measured by Bergoz DCCT
#MON NSLS2 naming:[PSy[:PI]][-SSy[:SI]][-TSy[:TI]]{Dev[:DI]}[SgN[:SgI][-SgD]]
#### Psy	-	Primary system
#### Ssy	-	Secondary system
#### Dev	-	Device name
#### MON	-	BR-BI{DCCT:1}

#for NSLS-2 Booster, Trev=528 ns
record(calc,"BR-BI{DCCT:1}QVSlope-Calc_")
{
   field(DESC,"slope:beam charge/V")
   field(INPA,"BR-BI{DCCT:1}IVSlope-Calc_")
   field(INPB,"528.0")
   field(CALC,"A*B*0.001")
   field(PREC,"5")
   field(EGU,"nC/V")
}

record(calc,"BR-BI{DCCT:1}QOffset-I")
{
   field(DESC,"beam charge offset")
   field(INPA,"BR-BI{DCCT:1}IOffset-SP CP")
   field(INPB,"528.0")
   field(CALC,"A*B*0.001")   
   field(PREC,"3")
   field(EGU,"nC")
}

#four samples/points/locations to support Booster stack mode
#P1: the first spike, the first shot
#P2: ~ 100 ms beam decay
#P3: the second jump/spike if it is in stack mode, ~100 ms after the first shot
#P4: beam extracted, down to near zero 
#PX: user selected point in the unit of ms

record(ao, "BR-BI{DCCT:1}PointXTime-SP")
{
    field(DESC, "time after BR injection in ms")
    field(OUT,  "BR-BI{DCCT:1}PointXTime-Calc_ PP")
    field(PREC, "1")
    field(EGU,  "ms")
    field(PINI, "YES")
    field(DRVL, "0")
    field(DRVH, "900")
    info(autosaveFields_pass0, VAL)
}

record(calcout, "BR-BI{DCCT:1}PointXTime-Calc_")
{
    field(INPA, "BR-BI{DCCT:1}PointXTime-SP")
    field(INPB, "BR-BI{DCCT:1}I:Point1-I.INDX CP")
    field(INPC, "BR-BI{DIG:DCCT}SampleRate-SP CP")
    field(CALC, "FLOOR(A*C+B)")
    field(OUT,  "BR-BI{DCCT:1}I:PointX-Sub_.INDX")
    field(FLNK, "BR-BI{DCCT:1}I:PointX-Sub_")    
}

record(subArray,"BR-BI{DCCT:1}I:PointX-Sub_")
{
   field(DESC,"user selected pointX")
   field(INP,"BR-BI{DCCT:1}I-Wf CPP")
   field(MALM,"18000")
   #INDX can be changed by caput
   field(INDX,"266")
   field(NELM,"1")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
   field(FLNK,"BR-BI{DCCT:1}I:PointX-I")
}

record(ai, "BR-BI{DCCT:1}I:PointX-I")
{
    field(DESC, "current at time X ms")
    field(INP, "BR-BI{DCCT:1}I:PointX-Sub_")
    field(PREC,"3")
    field(EGU,"mA")
    field(FLNK, "BR-BI{DCCT:1}Q:PointX-I")
}

record(calc,"BR-BI{DCCT:1}Q:PointX-I")
{
   field(DESC,"Q at point X")
   field(INPA,"BR-BI{DCCT:1}I:PointX-I")
   field(INPB,"528.0")
   field(CALC,"A*B*0.001")
   field(PREC,"3")
   field(EGU,"nC")
}

record(subArray,"BR-BI{DCCT:1}I:Point1-I")
{
   field(DESC,"the fist spike")
   field(INP,"BR-BI{DCCT:1}I-Wf_ CP")
   field(MALM,"18000")
   #INDX can be changed by caput
   #50 us * 266 = 13.3 ms
   field(INDX,"266")
   field(NELM,"1")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
   field(FLNK,"BR-BI{DCCT:1}I:Point2-I")
   field(PINI,"YES")
   info(autosaveFields_pass0, INDX)
}

#100 ms / 0.05ms = 2000
record(subArray,"BR-BI{DCCT:1}I:Point2-I")
{
   field(DESC,"100ms beam decay")
   field(INP,"BR-BI{DCCT:1}I-Wf_")
   field(MALM,"18000")
   field(INDX,"2266")
   field(NELM,"1")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
   field(FLNK,"BR-BI{DCCT:1}I:Point3-I")
   field(PINI,"YES")
   info(autosaveFields_pass0, INDX)
}

record(subArray,"BR-BI{DCCT:1}I:Point3-I")
{
   field(DESC,"the second spike")
   field(INP,"BR-BI{DCCT:1}I-Wf_")
   field(MALM,"18000")
   field(INDX,"2268")
   field(NELM,"1")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
   field(FLNK,"BR-BI{DCCT:1}I:Point4-I")
   field(PINI,"YES")
   info(autosaveFields_pass0, INDX)
}

record(subArray,"BR-BI{DCCT:1}I:Point4-I")
{
   field(DESC,"beam extracted")
   field(INP,"BR-BI{DCCT:1}I-Wf_")
   field(MALM,"18000")
   field(INDX,"7500")
   field(NELM,"1")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
   field(FLNK,"BR-BI{DCCT:1}Q:Point1-I")
   field(PINI,"YES")
   info(autosaveFields_pass0, INDX)
}

record(calc,"BR-BI{DCCT:1}Q:Point1-I")
{
   field(DESC,"beam charge at point 1")
   field(INPA,"BR-BI{DCCT:1}I:Point1-I")
   field(INPB,"528.0")
   field(CALC,"A*B*0.001")   
   field(PREC,"3")
   field(EGU,"nC")
   field(FLNK,"BR-BI{DCCT:1}Q:Point2-I")
}

record(calc,"BR-BI{DCCT:1}Q:Point2-I")
{
   field(DESC,"beam charge at point 2")
   field(INPA,"BR-BI{DCCT:1}I:Point2-I")
   field(INPB,"528.0")
   field(CALC,"A*B*0.001")   
   field(PREC,"3")
   field(EGU,"nC")
   field(FLNK,"BR-BI{DCCT:1}Q:Point3-I")
}

record(calc,"BR-BI{DCCT:1}Q:Point3-I")
{
   field(DESC,"beam charge at point 3")
   field(INPA,"BR-BI{DCCT:1}I:Point3-I")
   field(INPB,"528.0")
   field(CALC,"A*B*0.001")   
   field(PREC,"3")
   field(EGU,"nC")
   field(FLNK,"BR-BI{DCCT:1}Q:Point4-I")
}

record(calc,"BR-BI{DCCT:1}Q:Point4-I")
{
   field(DESC,"beam charge at point 4:extract")
   field(INPA,"BR-BI{DCCT:1}I:Point4-I")
   field(INPB,"528.0")
   field(CALC,"A*B*0.001")   
   field(PREC,"3")
   field(EGU,"nC")
   field(FLNK,"BR-BI{DCCT:1}I:1stShot-I")
}

record(ai,"BR-BI{DCCT:1}I:1stShot-I")
{
   field(DESC,"first shot current")
   field(INP,"BR-BI{DCCT:1}I:Point1-I")
   field(PREC,"3")
   field(MDEL,"-1")
   field(EGU,"mA")
   field(FLNK,"BR-BI{DCCT:1}I:2ndShot-I")
}

record(calc,"BR-BI{DCCT:1}I:2ndShot-I")
{
   field(DESC,"second shot current in stack mode")
   field(INPA,"BR-BI{DCCT:1}I:Point3-I")
   field(INPB,"BR-BI{DCCT:1}I:Point2-I")
   #threshold: (0.1 nC / 528 ns)*1000 = 0.189 mA
   field(INPC,"0.189")
   field(CALC,"(A-B>C)?(A-B):0")   
   field(PREC,"3")
   field(EGU,"mA")
   field(MDEL,"-1")
   field(FLNK,"BR-BI{DCCT:1}I:Total-I")
}

record(calc,"BR-BI{DCCT:1}I:Total-I")
{
   field(DESC,"total injected beam current")
   field(INPA,"BR-BI{DCCT:1}I:1stShot-I")
   field(INPB,"BR-BI{DCCT:1}I:2ndShot-I")
   field(CALC,"A+B")   
   field(PREC,"3")
   field(EGU,"mA")
   field(MDEL,"-1")
   field(FLNK,"BR-BI{DCCT:1}Q:1stShot-I")
}

record(ai,"BR-BI{DCCT:1}Q:1stShot-I")
{
   field(DESC,"first shot charge")
   field(INP,"BR-BI{DCCT:1}Q:Point1-I")
   field(PREC,"3")
   field(EGU,"nC")
   field(MDEL,"-1")
   field(FLNK,"BR-BI{DCCT:1}Q:2ndShot-I")
}

record(calc,"BR-BI{DCCT:1}Q:2ndShot-I")
{
   field(DESC,"second shot charge in stack mode")
   field(INPA,"BR-BI{DCCT:1}Q:Point3-I")
   field(INPB,"BR-BI{DCCT:1}Q:Point2-I")
   #threshold: (0.1 nC / 528 ns)*1000 = 0.189 mA
   field(INPC,"0.1")
   field(CALC,"(A-B>C)?(A-B):0")   
   field(PREC,"3")
   field(EGU,"nC")
   field(MDEL,"-1")
   field(FLNK,"BR-BI{DCCT:1}Q:Total-I")
}

record(calc,"BR-BI{DCCT:1}Q:Total-I")
{
   field(DESC,"total injected beam charge")
   field(INPA,"BR-BI{DCCT:1}Q:1stShot-I")
   field(INPB,"BR-BI{DCCT:1}Q:2ndShot-I")
   field(CALC,"A+B")   
   field(PREC,"3")
   field(EGU,"nC")
   field(MDEL,"-1")
   field(FLNK,"BR-BI{DCCT:1}I:Extracted-I")
}

#QSum:1h-I: one-hour integrated charge
record(compress, "BR-BI{DCCT:1}QSum:1h-Com_")
{
    field(DESC, "one-hour buffer of QRate data")
    field(INP,  "BR-BI{DCCT:1}Q:Total-I CP")
    field(ALG,  "Circular Buffer")
    field(NSAM, "3600")
    field(FLNK,"BR-BI{DCCT:1}QSum:1h-Acalc_")
}

record(acalcout, "BR-BI{DCCT:1}QSum:1h-Acalc_")
{
    field(DESC, "one-hour integrated charge")
    field(NELM, "3600")
    field(INAA, "BR-BI{DCCT:1}QSum:1h-Com_")
    field(CALC, "SUM(AA)/1000.0")
    field(NUSE, "3600")
    field(OUT,  "BR-BI{DCCT:1}QSum:1h-I PP")
}

record(ai, "BR-BI{DCCT:1}QSum:1h-I")
{
    field(DESC, "one-hour integrated charge")
    field(PREC, "3")
    field(EGU, "uC")
}


record(ai,"BR-BI{DCCT:1}I:Extracted-I")
{
   field(DESC,"beam charge at extraction")
   field(INP,"BR-BI{DCCT:1}I:Point4-I")
   field(PREC,"3")
   field(EGU,"mA")
   field(MDEL,"-1")
   field(FLNK,"BR-BI{DCCT:1}Efficiency-I")
}

record(calc,"BR-BI{DCCT:1}Efficiency-I")
{
   field(DESC,"efficiency:charge loss")
   field(INPA,"BR-BI{DCCT:1}Q:Total-I")
   field(INPB,"BR-BI{DCCT:1}Q:Point4-I")
   field(INPC,"-1")
   field(INPD,"0.1")
   field(CALC,"A<D||A<B?C:100*B/A")   
   field(MDEL,"-1")
   field(PREC,"1")
   field(EGU,"%")
   field(FLNK,"BR-BI{DCCT:1}QLoss-I")
}

record(calc,"BR-BI{DCCT:1}QLoss-I")
{
   field(DESC,"charge loss")
   field(INPA,"BR-BI{DCCT:1}Q:Total-I")
   field(INPB,"BR-BI{DCCT:1}Q:Point4-I")
   field(INPC,"-1")
   field(INPD,"0.1")
   field(CALC,"A<B?0:A-B")   
   field(PREC,"4")
   field(EGU,"nC")
   field(MDEL,"-1")
   field(FLNK,"BR-BI{DCCT:1}QLossSum:1h-Com_")
}

record(calc,"BR-BI{DCCT:1}ILoss-I")
{
   field(DESC,"charge loss")
   field(INPA,"BR-BI{DCCT:1}QLoss-I CP")
   field(INPB,"528.0")
   field(CALC,"1000*A/B")
   field(PREC,"3")
   field(EGU,"mA")
   field(MDEL,"-1")
}

#QLossSum:1h-I: one-hour integrated charge
record(compress, "BR-BI{DCCT:1}QLossSum:1h-Com_")
{
    field(DESC, "one-hour buffer of QLoss data")
    field(INP,  "BR-BI{DCCT:1}QLoss-I")
    field(ALG,  "Circular Buffer")
    field(NSAM, "3600")
    field(FLNK,"BR-BI{DCCT:1}QLossSum:1h-Acalc_")
}

record(acalcout, "BR-BI{DCCT:1}QLossSum:1h-Acalc_")
{
    field(DESC, "one-hour integrated charge")
    field(NELM, "3600")
    field(INAA, "BR-BI{DCCT:1}QLossSum:1h-Com_")
    field(CALC, "SUM(AA)/1000.0")
    field(NUSE, "3600")
    field(OUT,  "BR-BI{DCCT:1}QLossSum:1h-I PP")
}

record(ai, "BR-BI{DCCT:1}QLossSum:1h-I")
{
    field(DESC, "one-hour integrated charge")
    field(PREC, "3")
    field(EGU, "uC")
    field(MDEL,"-1")
}

#averaging extraction charge Q over interested number of shots(INOS)
record(compress,"BR-BI{DCCT:1}AveQOverINOS-I")
{
	field(DESC, "average charge over INOS")
	#INP is scalar
    field(INP,"BR-BI{DCCT:1}Q:Point4-I CP")
	field(ALG,"N to 1 Average")
	field(NSAM,"1")
	#N can't be DB_LINK, must be constant
	#field(N,"${MON}NbrShots-SP CP NMS")
	#N can be changed to the interested number of shots at run-time
	field(N,"10")
	field(PREC,"3")
	field(EGU,"nC")
	info(autosaveFields_pass0, "N")
	field(FLNK,"BR-BI{DCCT:1}AveIOverINOS-I")
}

record(calc,"BR-BI{DCCT:1}AveIOverINOS-I")
{
   field(DESC,"average current over INOS")
   field(INPA,"BR-BI{DCCT:1}AveQOverINOS-I")
   field(INPB,"528.0")
   field(CALC,"(A/B)*1000")   
   field(PREC,"3")
   field(EGU,"mA")
}

#circular buffer of extraction charge Q for Booster
#record(compress,"${MON}CircularQ-com_")
record(compress,"BR-BI{DCCT:1}CircularQ-com_")
{
	field(DESC, "circular buffer Q")
	#INP is scalar
	field(INP,"BR-BI{DCCT:1}Q:Point4-I CP")
	field(ALG,"Circular Buffer")
	field(NSAM,"10")
	#NSAM can't be changed to the interested number of shots at run-time
	#N can be changed by caput
    field(FLNK,"BR-BI{DCCT:1}Buffer-aSub_")
}

#see ics710ProcessWfAsbu.cpp: process INOS buffered data.
record(aSub,"BR-BI{DCCT:1}Buffer-aSub_")
{
    field (DESC,"process buffered data")
    field (SNAM,"processBuf")
    field (INPA, "BR-BI{DCCT:1}Q:Point4-I")
    field (FTA, "DOUBLE")
    field (NOA, "1")
    #N is the interested number of shots
    field (INPB, "BR-BI{DCCT:1}AveQOverINOS-I.N")
    field (FTB, "ULONG")
    field (NOB, "1")
    field (INPC, "BR-BI{DCCT:1}Q:Point4-I")
    field (FTC, "DOUBLE")
    field (NOC, "1")
    #event rate / injection rate from LN-TS{}Mode-Sel
    #field (INPD, "LN-TS{}ShotsPerSecond-Calc_")
    field (INPD, "1")
    field (FTD, "ULONG")
    field (NOD, "1")
    field (INPE, "BR-BI{DCCT:1}CircularQ-com_")
    field (FTE, "DOUBLE")
    field (NOE, "10")
    field (OUTA, "BR-BI{DCCT:1}StdQOverINOS-I PP")
    field (FTVA, "DOUBLE")
    field (NOVA, "1")
    field (OUTB, "BR-BI{DCCT:1}QRateNoMovingAve-I PP")
    field (FTVB, "DOUBLE")
    field (NOVB, "1")
    field (OUTC, "BR-BI{DCCT:1}AveVROI-Buf_ PP")
    field (FTVC, "DOUBLE")
    field (NOVC, "60")
    field (OUTD, "BR-BI{DCCT:1}Q-Buf_ PP")
    field (FTVD, "DOUBLE")
    field (NOVD, "60")
    field (OUTE, "BR-BI{DCCT:1}QRate-I PP")
    field (FTVE, "DOUBLE")
    field (NOVE, "1")
}

#std Q over interested number of shots (INOS)
record(ai,"BR-BI{DCCT:1}StdQOverINOS-I")
{
   field(DESC,"stdQ over NOIS")
   field(INP,"BR-BI{DCCT:1}Buffer-aSub_.VALA")
   field(PREC,"3")
   field(EGU,"nC")
   field(FLNK,"BR-BI{DCCT:1}StdIOverINOS-I")
}

record(calc,"BR-BI{DCCT:1}StdIOverINOS-I")
{
   field(DESC,"std current over INOS")
   field(INPA,"BR-BI{DCCT:1}StdQOverINOS-I")
   field(INPB,"528.0")
   field(CALC,"(A/B)*1000")   
   field(PREC,"3")
   field(EGU,"mA")
}

record(ai,"BR-BI{DCCT:1}QRateNoMovingAve-I")
{
   field(DESC,"QRate without moving average")
   field(INP,"BR-BI{DCCT:1}Buffer-aSub_.VALB")
   field(PREC,"3")
   field(EGU,"nC/s")
}

record(waveform,"BR-BI{DCCT:1}AveVROI-Buf_")
{
   field(DESC,"AveVROI buffer")
   field(INP,"BR-BI{DCCT:1}Buffer-aSub_.VALC")
   field(NELM,"60")
   field(FTVL,"DOUBLE")
   field(PREC,"6")
   field(EGU,"V")
}

record(waveform,"BR-BI{DCCT:1}Q-Buf_")
{
   field(DESC,"Q buffer")
   field(INP,"BR-BI{DCCT:1}Buffer-aSub_.VALD")
   field(NELM,"60")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"nC")
}

#QRate is moving sum
record(ai,"BR-BI{DCCT:1}QRate-I")
{
   field(DESC,"QRate with moving sum")
   field(INP,"BR-BI{DCCT:1}Buffer-aSub_.VALE")
   field(PREC,"3")
   field(EGU,"nC/s")
}

