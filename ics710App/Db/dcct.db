## Process digitizer data to get the beam current measured by Bergoz DCCT
#MON NSLS2 naming:[PSy[:PI]][-SSy[:SI]][-TSy[:TI]]{Dev[:DI]}[SgN[:SgI][-SgD]]
#### Psy	-	Primary system
#### Ssy	-	Secondary system
#### Dev	-	Device name
#### MON	-	BR-BI{DCCT:1}

#common database for stored beam current at Booster and Storage Ring
#dcctSR.db and dcctBR are specific for SR and BR
#Bergoz DCCT current is calibrated against gain settings 
#and Q offset (background noise)

#The RVAL and VAL of mbbi: [0, 15]; 
#use mbbo here: VAL--[0,15], RVAL--[0,65535] 
#record(mbbi, "${MON}FullScale-I")
record(mbbo, "${MON}FullScale-I")
{
  field(DESC,"scale: 20mA ~ 20000mA")
  field(DTYP,"Raw Soft Channel")
  #must use closed_loop
  field(OMSL, "closed_loop")
  #${MON}Range-Sel is in the ltb-plc IOC 
  field(DOL, "${MON}Range-Sel CP")
  field(ZRVL, "20000")
  field(ONVL, "2000")
  field(TWVL, "200")
  field(THVL, "20")
  field(ZRST, "20A")
  field(ONST, "2A")
  field(TWST, "200mA")
  field(THST, "20mA")
}

#IVSlope is calculated in Python-based calibration ioc
#IVSlope is a negative value for SR DCCT
record(ai,"${MON}IVSlope-Calc_")
{
   field(DESC,"slope:beam current/V")
   #field(INPA,"${MON}FullScale-I.RVAL")
   #field(INPB,"10.0")
   #field(CALC,"A/B")
   field(VAL, "-20")
   field(PREC,"5")
   field(EGU,"mA/V")
   field(PINI, "1")
   info(autosaveFields_pass0, "VAL")
#${MON}QVSlope-Calc_ is in another ioc: QVSlope is different for BR and SR
   #field(FLNK, "${MON}QVSlope-Calc_.PROC")
}

#${MON}IOffset-SP is based on AveI
record(ao,"${MON}IOffset-SP")
{
   field(DESC,"beam current offset")
   field(PINI,"1")
   field(PREC,"3")
   field(EGU,"mA")
   info(autosaveFields_pass0, "VAL")
   #field(FLNK,"BR-BI{DCCT:1}QOffset-I.PROC")
}

record(calc,"${MON}AveI-I")
{
   field(DESC,"average current")
   field(INPA,"${MON}AveV-I CP")
   field(INPB,"${MON}IVSlope-Calc_")
   field(CALC,"A*B")
   field(PREC,"5")
   field(EGU,"mA")
   field(FLNK,"${MON}AveI-Com_")
}
record(compress,"${MON}AveI-Com_")
{
	field(DESC, "circular buffer of AveI")
	field(INP,  "${MON}AveI-I")
	field(ALG,	"Circular Buffer")
	field(NSAM, "10")
}
record(acalcout, "${MON}StdOverAveI-acalc_")
{
    field(DESC, "std of AveI")
    field(NELM, "10")
    field(NUSE, "10")
    field(INAA, "${MON}AveI-Com_ CP")
    field(CALC, "STD(AA)")
    field(NUSE, "10")
    field(OUT,  "${MON}StdOverAveI-I PP")
}
#Is this the DCCT resolutoin? Not sure
record(ai, "${MON}StdOverAveI-I")
{
    field(EGU, "mA")
   field(FLNK,"${MON}AveQ-I")
}
record(calc,"${MON}AveQ-I")
{
   field(DESC,"average charge")
   field(INPA,"${MON}AveV-I")
   field(INPB,"${MON}QVSlope-Calc_")
   field(CALC,"A*B")
   field(PREC,"5")
   field(EGU,"nC")
}
#it seems this is the DCCT resolution: StdV over the whole waveform data
record(calc,"${MON}RMSNoise-I")
{
   field(DESC,"Resolution")
   field(INPA,"${MON}StdV-I CP")
   field(INPB,"${MON}IVSlope-Calc_")
#IVSlope is a negative value
   field(CALC,"-1.0*A*B")
   field(PREC,"5")
   field(EGU,"uA")
}

#waveforms: I and Q
record(acalcout,"${MON}I-aCalc_")
{
   field(DESC,"Beam current by DCCT")
   field(NELM,"${NELM}")
   field(NUSE,"${NELM}")
   field(INAA,"${MON}V-Wf CP")
   field(INPA,"${MON}IVSlope-Calc_")
   field(INPB,"${MON}IOffset-SP")
   #field(CALC,"ABS((A*AA)-B)")
   field(CALC,"(A*AA)-B")
   field(PREC,"3")
   field(EGU,"mA")
   field(OUT,"${MON}I-Wf_ PP")
}
#I-Wf_ is used for SR DCCT and I-Wf is for BR DCCT
#the ICS 710 digitizer has ~63 pre-trigger (useless) data, which is not
#desired for BR DCCT
record(waveform,"${MON}I-Wf_")
{
   field(DESC,"beam current waveform data")
   field(NELM,"${NELM}")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
   field(FLNK, "${MON}I-Wf")
}
record(subArray,"${MON}I-Wf")
{
   field(DESC,"reduced waveform data")
   field(INP, "${MON}I-Wf_")
   field(MALM,"${NELM}")
   field(INDX,"63")
   field(NELM,"${NELM_}")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
   field(FLNK, "${MON}Q-aCalc_")
}
record(acalcout,"${MON}Q-aCalc_")
{
   field(DESC,"Beam charge by DCCT")
   field(NELM,"${NELM}")
   field(NUSE,"${NELM}")
   field(INAA,"${MON}V-Wf")
   field(INPA,"${MON}QVSlope-Calc_")
   field(INPB,"${MON}QOffset-I")
   #field(CALC,"ABS((A*AA)-B)")
   field(CALC,"(A*AA)-B")
   field(PREC,"3")
   field(EGU,"nC")
   field(OUT,"${MON}Q-Wf_ PP")
}
record(waveform,"${MON}Q-Wf_")
{
   field(DESC,"beam charge waveform data")
   field(NELM,"${NELM}")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"nC")
   field(FLNK, "${MON}Q-Wf")
}
record(subArray,"${MON}Q-Wf")
{
   field(DESC,"reduced waveform data")
   field(INP, "${MON}Q-Wf_")
   field(MALM,"${NELM}")
   field(INDX,"63")
   field(NELM,"${NELM_}")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"nC")
}

#DCCT calibration current source is DC calibrator KH526 
#calibration is implemented in Python
record(bo, "${MON}StartCal-Sel")
{
        field(DESC, "start calibration")
        field(ZNAM, "Started")
        field(ONAM, "Stopped")
	field(VAL,  "1")
	field(OUT, "${MON}StartCal-Calc.PROC")
}
record(calc, "${MON}StartCal-Calc")
{
        field(DESC, "counter")
	field(SDIS, "${MON}StartCal-Sel")
        field(INPA, "${MON}StartCal-Calc")
        field(CALC,  "A+1")
}
record(mbbi, "${MON}CalStatus-Sts")
{
	field(DESC, "system status")
	field(ZRST, "Done")
	field(ONST, "DC source disconnected")
	field(TWST, "In process, wait...")
	field(THST, "Adjust cal Max. input")
	field(FRST, "Adjust cal step size")
	field(FVST, "Only 100 steps performed")
}
record(ao, "${MON}CalStepSize-SP")
{
	field(EGU,  "mA")
	field(PREC, "1")
	field(VAL,  "10")
	field(PINI, "YES")
        info(autosaveFields_pass0, "VAL")
}
record(ao, "${MON}CalMaxInput-SP")
{
        field(EGU,  "mA")
        field(PREC, "1")
        field(VAL,  "90")
        field(PINI, "YES")
	field(DRVH, "90")
        info(autosaveFields_pass0, "VAL DRVH")
}
record(waveform,"${MON}CalInput-Wf")
{
   field(DESC,"DC source input")
   field(NELM,"100")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
    field(PINI, "1")
    info(autosaveFields_pass0, "VAL")
}
record(waveform,"${MON}CalOutput-Wf")
{
   field(DESC,"Readback data")
   field(NELM,"100")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
    field(PINI, "1")
    info(autosaveFields_pass0, "VAL")
}
#First-order coefficients by python-based polyfit
record(ai, "${MON}CalP0-I")
{
    field(PREC, "6")
    field(EGU,  "mA/V")
    field(PINI, "1")
    info(autosaveFields_pass0, "VAL")
}
record(ai, "${MON}CalP1-I")
{ 
    field(PREC, "3")
    field(EGU,  "mA")
    field(PINI, "1")
    info(autosaveFields_pass0, "VAL")
}
record(calcout, "${MON}ApplyFit-Calc_")
{
    field(INPA, "${MON}CalP0-I")
    field(CALC, "A")
    field(OUT,  "${MON}IVSlope-Calc_ PP")
}
