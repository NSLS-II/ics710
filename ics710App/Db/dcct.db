## Process digitizer data to get the beam current measured by Bergoz DCCT
#MON NSLS2 naming:[PSy[:PI]][-SSy[:SI]][-TSy[:TI]]{Dev[:DI]}[SgN[:SgI][-SgD]]
#### Psy	-	Primary system
#### Ssy	-	Secondary system
#### Dev	-	Device name
#### MON	-	BR-BI{DCCT:1}

#stored beam current at Booster and Ring
#Bergoz DCCT current is calibrated against gain settings 
#and Q offset (background noise)
#The RVAL and VAL of mbbi: [0, 15]; 
#use mbbo here: VAL--[0,15], RVAL--[0,65535] 
#record(mbbi, "${MON}FullScale-I")
record(mbbo, "${MON}FullScale-I")
{
  field(DESC,"scale: 20mA ~ 20000mA")
  field(DTYP,"Raw Soft Channel")
  #must use closed_loop
  field(OMSL, "closed_loop")
  #${MON}Range-Sel is in the ltb-plc IOC 
  field(DOL, "${MON}Range-Sel CP")
  field(ZRVL, "20000")
  field(ONVL, "2000")
  field(TWVL, "200")
  field(THVL, "20")
  field(ZRST, "20A")
  field(ONST, "2A")
  field(TWST, "200mA")
  field(THST, "20mA")
  field(FLNK, "${MON}IVSlope-Calc_")
}

record(calc,"${MON}IVSlope-Calc_")
{
   field(DESC,"slope:beam current/V")
   field(INPA,"${MON}FullScale-I.RVAL")
   field(INPB,"10.0")
   field(CALC,"A/B")
   field(PREC,"5")
   field(EGU,"mA/V")
   field(FLNK, "${MON}QVSlope-Calc_.PROC")
}

record(ao,"${MON}IOffset-SP")
{
   field(DESC,"beam current offset")
   field(PINI,"1")
   field(PREC,"3")
   field(EGU,"mA")
   info(autosaveFields_pass0, "VAL")
   #field(FLNK,"BR-BI{DCCT:1}QOffset-I.PROC")
}

#${MON}IOffset-SP is based on AveI
record(calc,"${MON}AveI-I")
{
   field(DESC,"average current")
   field(INPA,"${MON}AveV-I CP")
   field(INPB,"${MON}IVSlope-Calc_")
   field(CALC,"A*B")
   field(PREC,"5")
   field(EGU,"mA")
   field(FLNK,"${MON}AveI-Com_")
}

record(compress,"${MON}AveI-Com_")
{
	field(DESC, "circular buffer of AveI")
	field(INP,  "${MON}AveI-I")
	field(ALG,	"Circular Buffer")
	field(NSAM, "10")
}

record(acalcout, "${MON}StdOverAveI-acalc_")
{
    field(DESC, "std of AveI")
    field(NELM, "10")
    field(NUSE, "10")
    field(INAA, "${MON}AveI-Com_ CP")
    field(CALC, "STD(AA)")
    field(NUSE, "10")
    field(OUT,  "${MON}StdOverAveI-I PP")
}

record(ai, "${MON}StdOverAveI-I")
{
	field(EGU, "mA")
}

record(acalcout,"${MON}I-aCalc_")
{
   field(DESC,"Beam current by DCCT")
   field(NELM,"100000")
   field(NUSE,"100000")
   field(INAA,"${MON}V-Wf CP")
   field(INPA,"${MON}IVSlope-Calc_")
   field(INPB,"${MON}IOffset-SP")
   field(CALC,"ABS((A*AA)-B)")
   field(PREC,"3")
   field(EGU,"mA")
   field(NUSE,"100000")
   field(OUT,"${MON}I-Wf_ PP")
}

record(waveform,"${MON}I-Wf_")
{
   field(DESC,"beam current waveform data")
   field(NELM,"100000")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
   field(FLNK, "${MON}I-Wf")
}

record(subArray,"${MON}I-Wf")
{
   field(DESC,"reduced waveform data")
   field(INP, "${MON}I-Wf_")
   field(MALM,"100000")
   field(INDX,"63")
   field(NELM,"99937")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
}

record(calc,"${MON}AveQ-I")
{
   field(DESC,"average charge")
   field(INPA,"${MON}AveV-I CP")
   field(INPB,"${MON}QVSlope-Calc_")
   field(CALC,"A*B")
   field(PREC,"5")
   field(EGU,"nC")
}

record(acalcout,"${MON}Q-aCalc_")
{
   field(DESC,"Beam charge by DCCT")
   field(NELM,"100000")
   field(NUSE,"100000")
   field(INAA,"${MON}V-Wf CP")
   field(INPA,"${MON}QVSlope-Calc_")
   field(INPB,"${MON}QOffset-I")
   field(CALC,"ABS((A*AA)-B)")
   field(PREC,"3")
   field(EGU,"nC")
   field(NUSE,"100000")
   field(OUT,"${MON}Q-Wf_ PP")
}

record(waveform,"${MON}Q-Wf_")
{
   field(DESC,"beam charge waveform data")
   field(NELM,"100000")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"nC")
   field(FLNK, "${MON}Q-Wf")
}

record(subArray,"${MON}Q-Wf")
{
   field(DESC,"reduced waveform data")
   field(INP, "${MON}Q-Wf_")
   field(MALM,"100000")
   field(INDX,"63")
   field(NELM,"99937")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"nC")
}

#DCCT calibration current source is DC calibrator KH526 
#calibration is implemented in Python
record(bo, "${MON}StartCal-Sel")
{
        field(DESC, "start calibration")
        field(ZNAM, "Started")
        field(ONAM, "Stopped")
	field(VAL,  "1")
	field(OUT, "${MON}StartCal-Calc.PROC")
}

record(calc, "${MON}StartCal-Calc")
{
        field(DESC, "counter")
	field(SDIS, "${MON}StartCal-Sel")
        field(INPA, "${MON}StartCal-Calc")
        field(CALC,  "A+1")
}

record(mbbi, "${MON}CalStatus-Sts")
{
	field(DESC, "system status")
	field(ZRST, "Done")
	field(ONST, "DC source disconnected")
	field(TWST, "In process, wait...")
	field(THST, "Adjust cal Max. input")
	field(FRST, "Adjust cal step size")
	field(FVST, "Only 100 steps performed")
}

record(ao, "${MON}CalStepSize-SP")
{
	field(EGU,  "mA")
	field(PREC, "1")
	field(VAL,  "10")
	field(PINI, "YES")
        info(autosaveFields_pass0, "VAL")
}

record(ao, "${MON}CalMaxInput-SP")
{
        field(EGU,  "mA")
        field(PREC, "1")
        field(VAL,  "180")
        field(PINI, "YES")
        info(autosaveFields_pass0, "VAL")
}

record(waveform,"${MON}CalInput-Wf")
{
   field(DESC,"DC source input")
   field(NELM,"100")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
}

record(waveform,"${MON}CalOutput-Wf")
{
   field(DESC,"Readback data")
   field(NELM,"100")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
}

#First-order coefficients by python-based polyfit
record(ai, "${MON}CalP0-I")
{
    field(PREC, "6")
}

record(ai, "${MON}CalP1-I")
{ 
    field(PREC, "3")
    field(EGU,  "mA")
}
