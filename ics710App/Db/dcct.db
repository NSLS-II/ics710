## Process digitizer data to get the beam current measured by Bergoz DCCT
#MON NSLS2 naming:[PSy[:PI]][-SSy[:SI]][-TSy[:TI]]{Dev[:DI]}[SgN[:SgI][-SgD]]
#### Psy	-	Primary system
#### Ssy	-	Secondary system
#### Dev	-	Device name
#### MON	-	BR-BI{DCCT:1}

#common database for stored beam current at Booster and Storage Ring
#dcctSR.db and dcctBR are specific for SR and BR
#Bergoz DCCT current is calibrated against gain settings 
#and Q offset (background noise)

#The RVAL and VAL of mbbi: [0, 15]; 
#use mbbo here: VAL--[0,15], RVAL--[0,65535] 
#record(mbbi, "${MON}FullScale-I")
record(mbbo, "${MON}FullScale-I")
{
  field(DESC,"scale: 20mA ~ 20000mA")
  field(DTYP,"Raw Soft Channel")
  #must use closed_loop
  field(OMSL, "closed_loop")
  #${MON}Range-Sel is in the ltb-plc IOC 
  field(DOL, "${MON}Range-Sel CP")
  field(ZRVL, "20000")
  field(ONVL, "2000")
  field(TWVL, "200")
  field(THVL, "20")
  field(ZRST, "20A")
  field(ONST, "2A")
  field(TWST, "200mA")
  field(THST, "20mA")
}

#IVSlope is calculated in Python-based calibration ioc
#IVSlope is a negative value for SR DCCT
record(ai,"${MON}IVSlope-Calc_")
{
   field(DESC,"slope:beam current/V")
   #field(INPA,"${MON}FullScale-I.RVAL")
   #field(INPB,"10.0")
   #field(CALC,"A/B")
   field(VAL, "-20")
   field(PREC,"5")
   field(EGU,"mA/V")
   field(PINI, "1")
   info(autosaveFields_pass0, "VAL")
#${MON}QVSlope-Calc_ is in another ioc: QVSlope is different for BR and SR
   #field(FLNK, "${MON}QVSlope-Calc_.PROC")
}

#${MON}IOffset-SP is calculated in Python-based calibration ioc
record(ao,"${MON}IOffset-SP")
{
   field(DESC,"Offset I0")
   field(PINI,"1")
   field(PREC,"3")
   field(EGU,"mA")
   info(autosaveFields_pass0, "VAL")
}
record(ao,"${MON}3rdOrderCoef-SP")
{
   field(DESC,"3dr order")
   field(PINI,"1")
   field(PREC,"3")
   field(EGU,"mA/V^3")
   info(autosaveFields_pass0, "VAL")
}
record(ao,"${MON}2ndOrderCoef-SP")
{
   field(DESC,"2nd order")
   field(PINI,"1")
   field(PREC,"3")
   field(EGU,"mA/V^2")
   info(autosaveFields_pass0, "VAL")
}

record(calc,"${MON}AveI-I")
{
   field(DESC,"average current")
   field(INPA,"${MON}AveV-I CP")
   field(INPB,"${MON}IVSlope-Calc_")
   field(INPC,"${MON}IOffset-SP")
   field(INPD,"${MON}3rdOrderCoef-SP")
   field(INPE,"${MON}2ndOrderCoef-SP")
   field(CALC,"D*A*A*A+E*A*A+B*A+C")
   field(PREC,"5")
   field(EGU,"mA")
   field(FLNK,"${MON}AveI-Com_")
}
record(compress,"${MON}AveI-Com_")
{
	field(DESC, "circular buffer of AveI")
	field(INP,  "${MON}AveI-I")
	field(ALG,	"Circular Buffer")
	field(NSAM, "10")
}
record(acalcout, "${MON}StdOverAveI-acalc_")
{
    field(DESC, "std of AveI")
    field(NELM, "10")
    field(NUSE, "10")
    field(INAA, "${MON}AveI-Com_ CP")
    field(CALC, "STD(AA)")
    field(NUSE, "10")
    field(OUT,  "${MON}StdOverAveI-I PP")
}
#Is this the DCCT resolutoin? Not sure
record(ai, "${MON}StdOverAveI-I")
{
    field(EGU, "mA")
   field(FLNK,"${MON}AveQ-I")
}
record(calc,"${MON}AveQ-I")
{
   field(DESC,"average charge")
   field(INPA,"${MON}AveV-I")
   field(INPB,"${MON}QVSlope-Calc_")
   field(CALC,"A*B")
   field(PREC,"5")
   field(EGU,"nC")
}
#it seems this is the DCCT resolution: StdV over the whole waveform data
record(calc,"${MON}RMSNoise-I")
{
   field(DESC,"Resolution")
   field(INPA,"${MON}StdV-I CP")
   field(INPB,"${MON}IVSlope-Calc_")
#IVSlope is a negative value
   field(CALC,"-1.0*A*B")
   field(PREC,"5")
   field(EGU,"uA")
}

#waveforms: I and Q
record(acalcout,"${MON}I-aCalc_")
{
   field(DESC,"Beam current by DCCT")
   field(NELM,"${NELM}")
   field(NUSE,"${NELM}")
   field(INAA,"${MON}V-Wf CP")
   field(INPA,"${MON}IVSlope-Calc_")
   field(INPB,"${MON}IOffset-SP")
   #field(CALC,"ABS((A*AA)-B)")
   field(CALC,"(A*AA)-B")
   field(PREC,"3")
   field(EGU,"mA")
   field(OUT,"${MON}I-Wf_ PP")
}
#I-Wf_ is used for SR DCCT and I-Wf is for BR DCCT
#the ICS 710 digitizer has ~63 pre-trigger (useless) data, which is not
#desired for BR DCCT
record(waveform,"${MON}I-Wf_")
{
   field(DESC,"beam current waveform data")
   field(NELM,"${NELM}")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
   field(FLNK, "${MON}I-Wf")
}
record(subArray,"${MON}I-Wf")
{
   field(DESC,"reduced waveform data")
   field(INP, "${MON}I-Wf_")
   field(MALM,"${NELM}")
   field(INDX,"63")
   field(NELM,"${NELM_}")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
   field(FLNK, "${MON}Q-aCalc_")
}
record(acalcout,"${MON}Q-aCalc_")
{
   field(DESC,"Beam charge by DCCT")
   field(NELM,"${NELM}")
   field(NUSE,"${NELM}")
   field(INAA,"${MON}V-Wf")
   field(INPA,"${MON}QVSlope-Calc_")
   field(INPB,"${MON}QOffset-I")
   #field(CALC,"ABS((A*AA)-B)")
   field(CALC,"(A*AA)-B")
   field(PREC,"3")
   field(EGU,"nC")
   field(OUT,"${MON}Q-Wf_ PP")
}
record(waveform,"${MON}Q-Wf_")
{
   field(DESC,"beam charge waveform data")
   field(NELM,"${NELM}")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"nC")
   field(FLNK, "${MON}Q-Wf")
}
record(subArray,"${MON}Q-Wf")
{
   field(DESC,"reduced waveform data")
   field(INP, "${MON}Q-Wf_")
   field(MALM,"${NELM}")
   field(INDX,"63")
   field(NELM,"${NELM_}")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"nC")
}

#DCCT calibration current source is DC calibrator KH526 
#calibration is implemented in Python
record(bo, "${MON}StartCal-Sel")
{
        field(DESC, "start calibration")
        field(ZNAM, "Started")
        field(ONAM, "Stopped")
	field(VAL,  "1")
	field(OUT, "${MON}StartCal-Calc.PROC")
}
record(calc, "${MON}StartCal-Calc")
{
        field(DESC, "counter")
	field(SDIS, "${MON}StartCal-Sel")
        field(INPA, "${MON}StartCal-Calc")
        field(CALC,  "A+1")
}
record(mbbi, "${MON}CalStatus-Sts")
{
	field(DESC, "system status")
	field(ZRST, "Done")
	field(ONST, "DC source disconnected")
	field(TWST, "In process, wait...")
	field(THST, "Adjust cal Max. input")
	field(FRST, "Adjust cal step size")
	field(FVST, "Only 100 steps performed")
	field(SXST, "DC calibrator not working")
}
record(ao, "${MON}CalStepSize-SP")
{
	field(EGU,  "mA")
	field(PREC, "1")
	field(VAL,  "10")
	field(PINI, "YES")
        info(autosaveFields_pass0, "VAL")
}
record(ao, "${MON}CalMaxInput-SP")
{
        field(EGU,  "mA")
        field(PREC, "1")
        field(VAL,  "90")
        field(PINI, "YES")
	field(DRVH, "1200")
        info(autosaveFields_pass0, "VAL DRVH")
}
record(waveform,"${MON}CalInput-Wf")
{
   field(DESC,"DC source output")
   field(NELM,"100")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"mA")
   field(PINI, "1")
   info(autosaveFields_pass1, "VAL")
}
record(waveform,"${MON}CalOutput-Wf")
{
   field(DESC,"Readback voltage")
   field(NELM,"100")
   field(FTVL,"DOUBLE")
   field(PREC,"3")
   field(EGU,"V")
   field(PINI, "1")
   info(autosaveFields_pass1, "VAL")
}
#First-order coefficients by python-based polyfit
record(ai, "${MON}CalP0:200mA-I")
{
    field(DESC, "3rd order")
    field(PREC, "6")
    field(EGU,  "mA/V^3")
    field(PINI, "1")
    info(autosaveFields_pass0, "VAL")
    field(FLNK, "${MON}CalP0-I")
}
record(ai, "${MON}CalP0:2A-I")
{
    field(DESC, "3rd order")
    field(PREC, "6")
    field(EGU,  "mA/V^3")
    field(PINI, "1")
    info(autosaveFields_pass0, "VAL")
    field(FLNK, "${MON}CalP0-I")
}
record(ai, "${MON}CalP1:200mA-I")
{
    field(DESC, "2nd order") 
    field(PREC, "3")
    field(EGU,  "mA/V^2")
    field(PINI, "1")
    info(autosaveFields_pass0, "VAL")
    field(FLNK, "${MON}CalP1-I")
}
record(ai, "${MON}CalP1:2A-I")
{
    field(DESC, "2nd order") 
    field(PREC, "3")
    field(EGU,  "mA/V^2")
    field(PINI, "1")
    info(autosaveFields_pass0, "VAL")
    field(FLNK, "${MON}CalP1-I")
}
record(ai, "${MON}CalP2:200mA-I")
{
    field(DESC, "1st order") 
    field(PREC, "3")
    field(EGU,  "mA/V")
    field(PINI, "1")
    info(autosaveFields_pass0, "VAL")
    field(FLNK, "${MON}CalP2-I")
}
record(ai, "${MON}CalP2:2A-I")
{
    field(DESC, "1st order") 
    field(PREC, "3")
    field(EGU,  "mA/V")
    field(PINI, "1")
    info(autosaveFields_pass0, "VAL")
    field(FLNK, "${MON}CalP2-I")
}
record(ai, "${MON}CalP3:200mA-I")
{
    field(DESC, "Offset I0") 
    field(PREC, "3")
    field(EGU,  "mA")
    field(PINI, "1")
    info(autosaveFields_pass0, "VAL")
    field(FLNK, "${MON}CalP3-I")
}
record(ai, "${MON}CalP3:2A-I")
{
    field(DESC, "Offset I0") 
    field(PREC, "3")
    field(EGU,  "mA")
    field(PINI, "1")
    info(autosaveFields_pass0, "VAL")
    field(FLNK, "${MON}CalP3-I")
}
record(calc, "${MON}CalP0-I")
{
    field(DESC, "3rd order")
    field(PREC, "3")
    field(EGU,  "mA/V^3")
    field(PINI, "1")
    field(INPA, "${MON}CalP0:200mA-I")
    field(INPB, "${MON}CalP0:2A-I")
    #Range-Sel: 1-->2A; 2-->200mA
    field(INPC, "${MON}Range-Sel")
    field(CALC, "C==1?B:A")
    info(autosaveFields_pass0, "VAL")
}
record(calc, "${MON}CalP1-I")
{
    field(DESC, "2nd order") 
    field(PREC, "3")
    field(EGU,  "mA/V^2")
    field(PINI, "1")
    field(INPA, "${MON}CalP1:200mA-I")
    field(INPB, "${MON}CalP1:2A-I")
    #Range-Sel: 1-->2A; 2-->200mA
    field(INPC, "${MON}Range-Sel")
    field(CALC, "C==1?B:A")
    info(autosaveFields_pass0, "VAL")
}
record(calc, "${MON}CalP2-I")
{
    field(DESC, "1st order")
    field(PREC, "3")
    field(EGU,  "mA/V")
    field(PINI, "1")
    field(INPA, "${MON}CalP2:200mA-I")
    field(INPB, "${MON}CalP2:2A-I")
    #Range-Sel: 1-->2A; 2-->200mA
    field(INPC, "${MON}Range-Sel")
    field(CALC, "C==1?B:A")
    info(autosaveFields_pass0, "VAL")
}
record(calc, "${MON}CalP3-I")
{
    field(DESC, "Offset I0")
    field(PREC, "6")
    field(EGU,  "mA")
    field(PINI, "1")
    field(INPA, "${MON}CalP3:200mA-I")
    field(INPB, "${MON}CalP3:2A-I")
    #Range-Sel: 1-->2A; 2-->200mA
    field(INPC, "${MON}Range-Sel")
    field(CALC, "C==1?B:A")
    info(autosaveFields_pass0, "VAL")
}

record(calcout, "${MON}ApplyFit-Calc_")
{
    field(INPA, "${MON}CalP2:200mA-I")
    field(INPB, "${MON}CalP2:2A-I")
    #Range-Sel: 1-->2A; 2-->200mA
    field(INPC, "${MON}Range-Sel")
    field(CALC, "C==1?B:A")
    field(OUT,  "${MON}IVSlope-Calc_ PP")
    field(FLNK, "${MON}ApplyFit-Calc2_")
}
record(calcout, "${MON}ApplyFit-Calc2_")
{
    field(INPA, "${MON}CalP3:200mA-I")
    field(INPB, "${MON}CalP3:2A-I")
    #Range-Sel: 1-->2A; 2-->200mA
    field(INPC, "${MON}Range-Sel")
    field(CALC, "C==1?B:A")
    field(OUT,  "${MON}IOffset-SP PP")
    field(FLNK, "${MON}ApplyFit-Calc3_")
}
record(calcout, "${MON}ApplyFit-Calc3_")
{
    field(INPA, "${MON}CalP0:200mA-I")
    field(INPB, "${MON}CalP0:2A-I")
    #Range-Sel: 1-->2A; 2-->200mA
    field(INPC, "${MON}Range-Sel")
    field(CALC, "C==1?B:A")
    field(OUT,  "${MON}3rdOrderCoef-SP PP")
    field(FLNK, "${MON}ApplyFit-Calc4_")
}
record(calcout, "${MON}ApplyFit-Calc4_")
{
    field(INPA, "${MON}CalP1:200mA-I")
    field(INPB, "${MON}CalP1:2A-I")
    #Range-Sel: 1-->2A; 2-->200mA
    field(INPC, "${MON}Range-Sel")
    field(CALC, "C==1?B:A")
    field(OUT,  "${MON}2ndOrderCoef-SP PP")
}

#auto switch coefficiency & offset based on DCCT range 
record(calcout, "${MON}CoefSwitch-Calc_")
{
    field(INPA, "${MON}CalP2:200mA-I")
    field(INPB, "${MON}CalP2:2A-I")
    #Range-Sel: 1-->2A; 2-->200mA
    field(INPC, "${MON}Range-Sel CP")
    field(CALC, "C==1?B:A")
    field(OUT,  "${MON}IVSlope-Calc_ PP")
    field(FLNK, "${MON}OffsetSwitch-Calc_")
}
record(calcout, "${MON}OffsetSwitch-Calc_")
{
    field(INPA, "${MON}CalP3:200mA-I")
    field(INPB, "${MON}CalP3:2A-I")
    #Range-Sel: 1-->2A; 2-->200mA
    field(INPC, "${MON}Range-Sel")
    field(CALC, "C==1?B:A")
    field(OUT,  "${MON}IOffset-SP PP")
    field(FLNK, "${MON}P0Switch-Calc_")
}
record(calcout, "${MON}P0Switch-Calc_")
{
    field(INPA, "${MON}CalP0:200mA-I")
    field(INPB, "${MON}CalP0:2A-I")
    #Range-Sel: 1-->2A; 2-->200mA
    field(INPC, "${MON}Range-Sel")
    field(CALC, "C==1?B:A")
    field(OUT,  "${MON}3rdOrderCoef-SP PP")
    field(FLNK, "${MON}P1Switch-Calc_")
}
record(calcout, "${MON}P1Switch-Calc_")
{
    field(INPA, "${MON}CalP1:200mA-I")
    field(INPB, "${MON}CalP1:2A-I")
    #Range-Sel: 1-->2A; 2-->200mA
    field(INPC, "${MON}Range-Sel")
    field(CALC, "C==1?B:A")
    field(OUT,  "${MON}2ndOrderCoef-SP PP")
}


