# Real beam current: no DCCT internal test && no DCCT external test source
## && data > offset 
record(calcout, "SR:C03-BI{DCCT:1}I:Real-Calc_")
{
    field(DESC, "Real beam?")
    #DCCT test mode: 0 means Inactive
    field(INPA, "SR:C03-BI{DCCT:1}I:Total-I CP")
    field(INPB, "SR:C03-BI{DCCT:1}TestMode-Sel")
    #external DC calibrator
    field(INPC, "SR:C03-BI{DCCT:1}Out:CalSrc-SP")
    #DCCT offset level
    field(INPD, "0.03")
    #RF status
    field(INPE, "SR-RF{Xmtr:D}State:Cur-Sts")
    #P3 secured?
    #field(INPF, "SR-RF{Xmtr:D}State:Cur-Sts")
    #PDU port for the external DC calibrator 
    #field(INPG, "SR:C02-CS{PDU:RGG1}Sts:Outlet5-Sts")
    field(CALC, "B=0&&C<0.001&&A>D?A:0")
    #field(OOPT, "When Non-zero")
    #field(DOPT, "Use OCAL")
    #field(OCAL, "A")
    field(OUT,  "SR:C03-BI{DCCT:1}I:Real-I PP")
}

record(ai, "SR:C03-BI{DCCT:1}I:Real-I")
{
    field(DESC, "Real beam current")
    field(EGU,  "mA")
    field(PREC, "3")
    field(MDEL, "-1")
    field(ADEL, "-1")
    field(FLNK, "SR:C03-BI{DCCT:1}Dosage-Calc_")
}

record(calcout, "SR:C03-BI{DCCT:1}Dosage-Calc_")
{
    field(DESC, "accumulated dosage")
    field(INPA, "SR:C03-BI{DCCT:1}Dosage-I")
    field(INPB, "SR:C03-BI{DCCT:1}I:Real-I")
    #C: for offset / compesation?
    field(INPC, "0.0")
    field(CALC, "A+B/3600.0+C")
    field(OUT,  "SR:C03-BI{DCCT:1}Dosage-I PP")  
}

record(ai, "SR:C03-BI{DCCT:1}Dosage-I")
{
    field(DESC, "accumulated dosage")
    field(EGU,  "mAh")
    field(PREC, "3")
    field(PINI, "1")
    # use autosave to handle ioc restart problem:
    ## will the accumulated dosage be zero?
    info(autosaveFields_pass0, "VAL")
}

record(bo, "SR:C03-BI{DCCT:1}DosageReset:h-Cmd")
{
	field(DESC, "reset hourly dosage")
        field(ZNAM, "No reset")
        field(ONAM, "Reset")
	field(HIGH, "3")
}

record(bo, "SR:C03-BI{DCCT:1}DosageReset:d-Cmd")
{
	field(DESC, "reset daily dosage")
        field(ZNAM, "No reset")
        field(ONAM, "Reset")
	field(HIGH, "3")
}

record(bo, "SR:C03-BI{DCCT:1}DosageReset:m-Cmd")
{
	field(DESC, "reset monthly dosage")
        field(ZNAM, "No reset")
        field(ONAM, "Reset")
	field(HIGH, "3")
}

#use case: operators can reset dosage after vaccumm leak
record(bo, "SR:C03-BI{DCCT:1}DosageReset-Cmd")
{
	field(DESC, "reset custom dosage")
        field(ZNAM, "No reset")
        field(ONAM, "Reset")
	field(HIGH, "3")
        field(FLNK, "SR:C03-BI{DCCT:1}DosageReset:TS-Sts")
}

record(stringin, "SR:C03-BI{DCCT:1}DosageReset:TS-Sts")
{
    field(DESC, "Timestamp for reset")
    field(DTYP, "Soft Timestamp")
    field(PINI,"YES")
    #%s gives a number (seconds since EPICS epoc)
    #field(INP,"@%s")
    field(INP, "@%b %d, %Y %H:%M:%S.%03f")
    info(autosaveFields_pass0, "VAL")
}

record(calcout, "SR:C03-BI{DCCT:1}DosSinceReset-Calc_")
{
    field(DESC, "accumulated dos since reset")
    field(INPA, "SR:C03-BI{DCCT:1}DosSinceReset-I")
    field(INPB, "SR:C03-BI{DCCT:1}I:Real-I CP")
    field(INPC, "SR:C03-BI{DCCT:1}DosageReset-Cmd")
    field(CALC, "C==1?0:A+B/3600.0")
    field(OUT,  "SR:C03-BI{DCCT:1}DosSinceReset-I PP")  
}

record(ai, "SR:C03-BI{DCCT:1}DosSinceReset-I")
{
    field(DESC, "accumulated dos since reset")
    field(EGU,  "mAh")
    field(PREC, "3")
}

#When we started to calculate the accumulated dosage (no reset)? Feb 10 2015
record(stringin, "SR:C03-BI{DCCT:1}Dos:StartTS-Sts")
{
  field(DESC, "timestamp:dos calc")
  field(PINI,"YES")
  field(VAL,"Feb 10 2015")
  info(autosaveFields_pass0, "VAL")
}

#hourly-, daily-, monthly-dosage is automatically reseted by Python
record(ai, "SR:C03-BI{DCCT:1}Dosage:1min-I_")
{
        field(DESC, "average I over 1-min")
        field(PREC, "3")
        field(EGU,  "mAh")
}
record(calcout, "SR:C03-BI{DCCT:1}Dosage:1h-Calc_")
{
    field(DESC, "average I over 1-hour")
    field(INPA, "SR:C03-BI{DCCT:1}Dosage:1h-I_")
    field(INPB, "SR:C03-BI{DCCT:1}I:Real-I CP")
    #C: for offset / compesation?
    field(INPC, "0.0")
    field(CALC, "A+B/3600.0+C")
    field(OUT,  "SR:C03-BI{DCCT:1}Dosage:1h-I_ PP")  
}
record(ai, "SR:C03-BI{DCCT:1}Dosage:1h-I_")
{
        field(DESC, "average I over 1-hour")
        field(PREC, "3")
        field(EGU,  "mAh")
        field(PINI,"YES")
        info(autosaveFields_pass0, "VAL")
}
record(calcout, "SR:C03-BI{DCCT:1}Dosage:1d-Calc_")
{
    field(DESC, "average I over 1-day")
    field(INPA, "SR:C03-BI{DCCT:1}Dosage:1d-I_")
    field(INPB, "SR:C03-BI{DCCT:1}I:Real-I CP")
    #C: for offset / compesation?
    field(INPC, "0.0")
    field(CALC, "A+B/3600.0+C")
    field(OUT,  "SR:C03-BI{DCCT:1}Dosage:1d-I_ PP")  
}
record(ai, "SR:C03-BI{DCCT:1}Dosage:1d-I_")
{
        field(DESC, "average I over 1-day")
        field(PREC, "3")
        field(EGU,  "mAh")
        field(PINI,"YES")
        info(autosaveFields_pass0, "VAL")
}
record(calcout, "SR:C03-BI{DCCT:1}Dosage:1mon-Calc_")
{
    field(DESC, "average I over 1-month")
    field(INPA, "SR:C03-BI{DCCT:1}Dosage:1mon-I_")
    field(INPB, "SR:C03-BI{DCCT:1}I:Real-I CP")
    #C: for offset / compesation?
    field(INPC, "0.0")
    field(CALC, "A+B/3600.0+C")
    field(OUT,  "SR:C03-BI{DCCT:1}Dosage:1mon-I_ PP")  
}
record(ai, "SR:C03-BI{DCCT:1}Dosage:1mon-I_")
{
        field(DESC, "average I over 1-month")
        field(PREC, "3")
        field(EGU,  "mAh")
        field(PINI,"YES")
        info(autosaveFields_pass0, "VAL")
}
#PreMon-PreDay: 02-17 (Feb 17, 2015)
record(stringin, "SR:C03-BI{DCCT:1}Dos:PreDay-Sts")
{
  field(PINI,"YES")
  field(VAL,"17")
  info(autosaveFields_pass0, "VAL")
}
record(stringin, "SR:C03-BI{DCCT:1}Dos:PreMon-Sts")
{
  field(PINI,"YES")
  field(VAL,"02")
  info(autosaveFields_pass0, "VAL")
}


#Beam dosage (mAh) related to vacumm system: compress-record-based calculation
record(compress,"SR:C03-BI{DCCT:1}Dosage:1min-Com_")
{
        field(DESC, "average I over 1-min")
        #INP is scalar
        field(INP,"SR:C03-BI{DCCT:1}I:Real-I CP")
        field(ALG,"N to 1 Average")
        field(NSAM,"1")
        field(N,"60")
        field(PREC,"3")
        field(EGU,"mA")
        field(FLNK,"SR:C03-BI{DCCT:1}Dosage:1min-I")
}

record(ai, "SR:C03-BI{DCCT:1}Dosage:1min-I")
{
        field(DESC, "average I over 1-min")
	field(INP,  "SR:C03-BI{DCCT:1}Dosage:1min-Com_")
        field(PREC, "3")
        field(EGU,  "mAh")
        field(MDEL, "-1")
	field(ADEL, "-1")
	field(FLNK, "SR:C03-BI{DCCT:1}Dosage:1h-Com_")
}

record(compress,"SR:C03-BI{DCCT:1}Dosage:1h-Com_")
{
        field(DESC, "average I over 1-hour")
        #INP is scalar
        field(INP,"SR:C03-BI{DCCT:1}Dosage:1min-I")
        field(ALG,"N to 1 Average")
        field(NSAM,"1")
        field(N,"60")
        field(PREC,"3")
        field(EGU,"mA")
        field(FLNK,"SR:C03-BI{DCCT:1}Dosage:1h-I")
}

record(ai, "SR:C03-BI{DCCT:1}Dosage:1h-I")
{
	field(INP,  "SR:C03-BI{DCCT:1}Dosage:1h-Com_")  
        field(MDEL, "-1")
        field(ADEL, "-1")
        field(DESC, "average I over 1-hour")
        field(PREC, "3")
        field(EGU,  "mAh")
	field(FLNK, "SR:C03-BI{DCCT:1}Dosage:1d-Com_")
}

record(compress,"SR:C03-BI{DCCT:1}Dosage:1d-Com_")
{
        field(DESC, "average I over 1-day")
        #INP is scalar
        field(INP,"SR:C03-BI{DCCT:1}Dosage:1h-I")
        field(ALG,"N to 1 Average")
        field(NSAM,"1")
        field(N,"24")
        field(PREC,"3")
        field(EGU,"mAh")
        field(FLNK,"SR:C03-BI{DCCT:1}Dosage:1d-I")
}

record(calc, "SR:C03-BI{DCCT:1}Dosage:1d-I")
{
        field(INPA,  "SR:C03-BI{DCCT:1}Dosage:1d-Com_")
        field(MDEL, "-1")
        field(ADEL, "-1")
        field(CALC, "24.0*A")
        field(DESC, "accumulated over 1-day")
        field(PREC, "3")
        field(EGU,  "mAh")
}

record(compress,"SR:C03-BI{DCCT:1}Dosage:1w-Com")
{
        field(DESC, "1-week dosage")
        #INP is scalar
        field(INP,"SR:C03-BI{DCCT:1}Dosage:1h-I CP")
        field(ALG,"Circular Buffer")
        field(NSAM,"168")
        field(PREC,"3")
        field(EGU,"mAh")
}

record(stringin, "SR:C03-BI{DCCT:1}Dosage:ST-Str")
{
        field(DESC, "Start time")
        field(PINI, "1")
        field(VAL,  "2014-03-10 00:00")
        info(autosaveFields_pass0, "VAL")
}

record(stringin, "SR:C03-BI{DCCT:1}Dosage:ET-Str")
{
        field(DESC, "End Time")
        field(PINI, "1")
        field(VAL,  "2014-03-12 00:00")
        info(autosaveFields_pass0, "VAL")
}

#caput SR:C03-BI{DCCT:1}Dosage-Cmd.PROC 1
record(calc, "SR:C03-BI{DCCT:1}Dosage-Cmd")
{
        field(INPA, "SR:C03-BI{DCCT:1}Dosage-Cmd")
        field(CALC, "A+1")
}

record(bo, "SR:C03-BI{DCCT:1}DataInterval-Cmd")
{
	field(DESC, "1-minute or 1-hour?")
        field(ZNAM, "Use hour-dosage")
        field(ONAM, "Use minute-dosage")
	field(HIGH, "900")
}

record(mbbi, "SR:C03-BI{DCCT:1}Dosage-Sts")
{
        field(ZRST, "Done")
        field(ONST, "time input error")
        field(TWST, "Retrieving data, wait...")
        field(THST, "Failed to retrieve data")
}

record(ai, "SR:C03-BI{DCCT:1}Dosage:Total-I")
{
        field(DESC, "Total dosage calc from archiver")
        field(EGU,  "mAh")
        field(PREC, "3")
        field(MDEL, "-1")
	field(ADEL, "-1")
}

