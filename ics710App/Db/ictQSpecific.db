## BCM output voltage; ICT data rate; LN ICT interlock test 
#MON NSLS2 naming:[PSy[:PI]][-SSy[:SI]][-TSy[:TI]]{Dev[:DI]}[SgN[:SgI][-SgD]]
#### Psy	-	Primary system
#### Ssy	-	Secondary system
#### Dev	-	Device name
#### MON	-	LTB-BI{ICT:1}

#each BCM has varied max. output voltage, not exactly 8.0V
#8.104V(BCM1-SN172),7.664V(BCM2-SN169),7.532V(BCM3-SN173),7.444V(BCM4-SN174)
record(ai,"LTB-BI{ICT:1}VFullScale-I")
{
   field(DESC,"BCM max.output voltage")
   field(VAL,"8.104")
   field(PREC,"3")
   field(EGU,"V")
   info(autosaveFields_pass0, "VAL")  
}
record(ai,"LTB-BI{ICT:2}VFullScale-I")
{
   field(DESC,"BCM max.output voltage")
   field(VAL,"7.664")
   field(PREC,"3")
   field(EGU,"V")
   info(autosaveFields_pass0, "VAL")
}
record(ai,"BTS-BI{ICT:1}VFullScale-I")
{
   field(DESC,"BCM max.output voltage")
   field(VAL,"7.532")
   field(PREC,"3")
   field(EGU,"V")
   info(autosaveFields_pass0, "VAL")
}
record(ai,"BTS-BI{ICT:2}VFullScale-I")
{
   field(DESC,"BCM max.output voltage")
   field(VAL,"7.444")
   field(PREC,"3")
   field(EGU,"V")
   info(autosaveFields_pass0, "VAL")
}


#injection rate calculated from LN-TS{}Mode-Sts
#record(calc,"LN-TS{}ShotsPerSecond-Calc_")
record(calc,"LTB-BI{ICT:1}ShotsPerSecond-Calc_")
{
   field(DESC,"injections per second")
   field(INPA,"LN-TS{}Mode-Sts CP")
   field(CALC,"A=3?(2:(A=4?(5:(A=5?10:A))))")
   field(EGU, "Shots")
}

record(calc,"LTB-BI{ICT:2}ShotsPerSecond-Calc_")
{
   field(DESC,"injections per second")
   field(INPA,"LN-TS{}Mode-Sts CP")
   field(CALC,"A=3?(2:(A=4?(5:(A=5?10:A))))")
   field(EGU, "Shots")
}

record(ai,"BTS-BI{ICT:1}ShotsPerSecond-Calc_")
{
   field(DESC,"only one shot per second")
   field(VAL,"1")
   field(EGU, "Shots")
}

record(ai,"BTS-BI{ICT:2}ShotsPerSecond-Calc_")
{
   field(DESC,"only one shot per second")
   field(VAL,"1")
   field(EGU, "Shots")
}


#Upon Tasha's request
record(calcout, "LTB-BI{ICT:1}QSum-LBSSOpn:1h-I_")
{
    field(DESC, "integrated Q when shutter open")
    field(INPA, "LTB-BI{ICT:1}QSum:1h-I CP")
    field(INPB, "LTB-PPS{Sh}Pos:Opn-Sts")
    field(INPC, "LTB-BI{ICT:1}Q-I")
    field(CALC, "B?A:A-C/1000.0")
    field(OUT,  "LTB-BI{ICT:1}QSum-LBSSOpn:1h-I PP MSS")
}

record(ai, "LTB-BI{ICT:1}QSum-LBSSOpn:1h-I") {
    field(DESC, "integrated Q when shutter open")
    field(PREC, "3")
    field(EGU, "uC")
    field(MDEL,"-1")
    field(HIGH,"90")
    field(HIHI,"81")
    field(HSV ,"MINOR")
    field(HHSV,"MAJOR")
}

record(calcout, "BTS-BI{ICT:2}QSum-LBSSOpn:1h-I_")
{
    field(DESC, "integrated Q when shutter open")
    field(INPA, "BTS-BI{ICT:2}QSum:1h-I CP")
    field(INPB, "BTS-PPS{Sh}Pos:Opn-Sts")
    field(INPC, "BTS-BI{ICT:2}Q-I")
    field(CALC, "B?A:A-C/1000.0")
    field(OUT,  "BTS-BI{ICT:2}QSum-LBSSOpn:1h-I PP MSS")
}

record(ai, "BTS-BI{ICT:2}QSum-LBSSOpn:1h-I") {
    field(DESC, "integrated Q when shutter open")
    field(PREC, "3")
    field(EGU, "uC")
    field(MDEL,"-1")
    field(HIGH,"10")
    field(HIHI,"9")
    field(HSV ,"MINOR")
    field(HHSV,"MAJOR")
}

#Ray's request on LTB ICT1 cross-checking 
record(calcout, "LTB-BI{ICT:1}CrossCheck-Calc_")
{
  field(DESC, "Calibration cross-check")
  field(INPA, "LTB-BI{ICT:1}Q-I")
  field(INPB, "LTB-BI{FC:1}Q-I")
  field(INPC, "LTB-BI{FC:2}Q-I CP")
  field(INPD, "LTB-BI{ICT:2}Q-I")
  field(INPE, "0.08")
  field(CALC, "(A<E&&B<E&&C<E&&D<E)?0:(A>=B*0.9&&A>=C*0.9&&A>=D*0.9)?1:2")
  field(OUT,  "LTB-BI{ICT:1}CrossCheck-Sts PP")
}

record(mbbi, "LTB-BI{ICT:1}CrossCheck-Sts")
{
  field(DESC, "Cross check result")
  field(ZRVL, "0")
  field(ONVL, "1")
  field(TWVL, "2")
  field(ZRST, "No beam, no check")
  field(ONST, "Cross-check passed")
  field(TWST, "Cross-check failed")
  field(ZRSV, "NO_ALARM")
  field(ONSV, "NO_ALARM")
  field(TWSV, "MAJOR")
}


#LN ICT interlock test: the most challenging or tricky part is
##enabling / diableing the BCM calibration output,
##which is controlled by the PLC scanning at 1 Hz and not synchronized with any device
##using calcout record to implement delay and determine when to write output

#CSS sets the record to 1, but it's back to 0 after 5 seconds
#be aware that if someone caput LTB-BI{ICT:1}InterlockTest-Cmd 0 during the 5-second period,
## LTB-BI{ICT:1}InterlockTest-Cmd will be 0 immediatly 
record(bo, "LTB-BI{ICT:1}InterlockTest-Cmd")
{
    field(DESC,"ICT interlock test")
    #field(HIGH,"5")
    field(FLNK,"LTB-BI{ICT:1}SysPrepare-Seq_")
}

#the BCM calibration charge should be 40 nC; Linac Timing to 1Hz
#LNK* are CA links: the same effect using PP or CA
record(seq, "LTB-BI{ICT:1}SysPrepare-Seq_")
{
  field(DESC, "System reset/prepare")
  field(DOL1, "3")
  field(LNK1, "LTB-BI{ICT:1}CalQ-Sel PP")
  field(DOL2, "1")
  field(LNK2, "LN-TS{}Mode-Sel PP")
  field(DOL3, "1")
  field(LNK3, "ACC-TS{}Mode:Commit-Cmd PP")
  field(DOL4, "1")
  field(LNK4, "LTB-BI{ICT:1}CalEna-Sel PP")
  field(FLNK, "LTB-BI{ICT:1}Delay1-Calc_")
}

#wait for 3 seconds: it takes time for the PLC to disable the BCM calibration output    
record(calcout, "LTB-BI{ICT:1}Delay1-Calc_")
{
  field(DESC, "Delay / Wait")
  field(INPA, "1")
  field(CALC, "A")
  field(ODLY, "3")
  field(OUT,  "LTB-BI{ICT:1}TestResult1-Calc_.PROC")
}

#get the first test result: "no beam, aborted" or continue...
record(calcout, "LTB-BI{ICT:1}TestResult1-Calc_")
{
  field(DESC, "aborted or continue?")
  field(INPA, "LTB-BI{ICT:1}QRate-I")
  field(CALC, "A<0.2?0:1")
  field(OUT,  "LTB-BI{ICT:1}InterlockTest-Sts PP")
  field(FLNK, "LTB-BI{ICT:1}TestContinue-Calc_")
}

record(calcout, "LTB-BI{ICT:1}TestContinue-Calc_")
{
  field(DESC, "test continue?")
  field(INPA, "LTB-BI{ICT:1}TestResult1-Calc_")
  field(CALC, "!A")
  field(OOPT, "When Zero")
  field(OUT,  "LTB-BI{ICT:1}EnableCal-Cmd_ PP")
}

#generate big pulse signal from BCM to trip the e-gun 
##enable the BCM calibration, then disable it 3 seconds later
record(bo, "LTB-BI{ICT:1}EnableCal-Cmd_")
{
  field(OUT, "LTB-BI{ICT:1}CalEna-Sel PP")
  field(FLNK,"LTB-BI{ICT:1}Delay2-Calc_") 
}

record(calcout, "LTB-BI{ICT:1}Delay2-Calc_")
{
  field(DESC, "Delay / Wait")
  field(INPA, "1")
  field(CALC, "A")
  field(ODLY, "3")
  field(OUT,  "LTB-BI{ICT:1}DisableCal-Cmd_.PROC")
}

record(bo, "LTB-BI{ICT:1}DisableCal-Cmd_")
{
  field(VAL, "1")
  field(OUT, "LTB-BI{ICT:1}CalEna-Sel PP")
  field(FLNK,"LTB-BI{ICT:1}Delay3-Calc_")
}

record(calcout, "LTB-BI{ICT:1}Delay3-Calc_")
{
  field(DESC, "Delay / Wait")
  field(INPA, "1")
  field(CALC, "A")
  field(ODLY, "3")
  field(OUT,  "LTB-BI{ICT:1}TestResult2-Calc_.PROC")
}

#get the second test result: test passed or failed
record(calcout, "LTB-BI{ICT:1}TestResult2-Calc_")
{
  field(DESC, "passed or failed?")
  field(INPA, "LTB-BI{ICT:1}QRate-I")
  field(CALC, "A<0.2?2:3")
  field(OUT,  "LTB-BI{ICT:1}InterlockTest-Sts PP")
}

record(mbbi, "LTB-BI{ICT:1}InterlockTest-Sts")
{
  field(DESC, "Interlock test result")
  field(ZRVL, "0")
  field(ONVL, "1")
  field(TWVL, "2")
  field(THVL, "3")
  field(FRVL, "4")
  field(ZRST, "No beam, test aborted!")
  field(ONST, "Test in progress,wait...")
  field(TWST, "Test passed!")
  field(THST, "Test failed!")
  field(FRST, "No test performed")
  field(ZRSV, "MINOR")
  field(ONSV, "NO_ALARM")
  field(TWSV, "NO_ALARM")
  field(THSV, "MAJOR")
  field(FRSV, "NO_ALARM")
  field(VAL, "4")
}


